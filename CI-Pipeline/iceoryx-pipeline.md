# iceoryx Pipeline

## Document Scope

Documentation for the iceoryx pipeline. This pipeline runs analysis tools over the iceoryx codebase to determine software quality.

## Building from Source

The source code for iceoryx is available from https://github.com/eclipse-iceoryx/iceoryx

Instructions on how to build the project from source is at https://github.com/eclipse-iceoryx/iceoryx/blob/master/doc/website/getting-started/installation.md

A Linux target is assumed for this pipeline. The instructions for building the current master are:

```bash
git clone https://github.com/eclipse-iceoryx/iceoryx.git
cd iceoryx
cmake -Bbuild -Hiceoryx_meta
cmake --build build
```

The *build* stage of the pipeline simply executes these steps.

## Axivion Integration

### Compiling the Sources

Axivion analyses the source code by replacing gcc with its own compiler, cafeCC, and then executing the normal build steps as defined in the project makefile. Several steps have to be carried out before this can be done.

The *gccsetup* tool simplifies the integration with gcc by analysing the configuration of the installed gcc (system header files location and search order, for example). The following command will write the gcc configuration to the current folder.

```bash
gccsetup --gcc gcc-9 --g++ g++-9 --config .
```

Next, the environment variable BAUHAUS_CONFIG has to be set to point to this folder, so that the Axivion tools can find it.

The Axivion compiler cafeCC supports the same command line options as gcc and can therefore be used as a drop-in replacement for gcc. It does not generate code by default, instead generating *.ir files containing the code analysis needed by axivion.

Another tool, irCC, is also provided by Axivion, and this tool generates both the *.ir files needed by Axivion, and the normal *.o files generated by gcc. This is needed for projects such as iceoryx, where early stages of the build script produce executables that are needed by later stages of the build.

iceoryx is a CMake-based project, and CMake can be forced to use a different compiler by setting the CMAKE_CXX_COMPILER:FILEPATH flags on the command line. Note that these flags need to be set on the command line when CMake is called, rather than using environment variables, as CMake does not always honour environment variables.

The tool irAR is the Axivion archiver and replaces the gcc linker.

The command to run CMake, but using the Axivion irCC conmpiler is:

```bash
cmake -Bbuild -Hiceoryx_meta -D CMAKE_C_COMPILER:FILEPATH=/opt/axivion/bauhaus-suite/bin/irCC -D CMAKE_CXX_COMPILER:FILEPATH=/opt/axivion/bauhaus-suite/bin/irCXX -D CMAKE_AR:FILEPATH=/opt/axivion/bauhaus-suite/bin/irAR
```

The actual build can be performed with the normal cmake command `cmake --build build`. However, this is prefixed with the option `CAFECC_OPTIONS=-B<path>` to strip the root folder from the file path, making the axivion output more concise and readable.

```bash
CAFECC_OPTIONS=-B`pwd` cmake --build build
```

When the build is finished, the final output of the axivion cafeCC build step is a *.ir file. However, iceoryx consists of a number of smaller libraries, each of which is compiled into a *.ir file. These must all be combined into one by using the Axivion linker tool. The following command combines all *.ir files into one, called iceoryx.ir

```bash
cafeCC -o iceoryx.ir --shared --include_unused -Wl,--whole-archive $(find . -name *.a.ir)
```

### Performing the analysis

The rules for the analysis are defined by the file *iceoryx_axivion.json* and the axivion tool *axivion_ci* uses this configuration file, together with the iceoryx.ir file to do the analysis. As in a previous step, the variable BAUHAUS_CONFIG has to point to the location of the configurastion file. The analysis is performed by the following command:

```bash
BAUHAUS_CONFIG=$AXIVION_DIR/iceoryx_axivion.json axivion_ci
```

This analysis also generates an iceoryx.rfg file with the analysis results.

## Lattix Integration

The integration of Lattix with iceoryx is greatly simplified since Lattix can read the *.ir and *.rfg files generated by Axivion, once they have been passed through the rfg2ldi2.py script.

```bash
rfgscript $LATTIX_DIR/rfg2ldi2.py $AXIVION_DIR/iceoryx.rfg -i $AXIVION_DIR/iceoryx.ir Include File out1.ldi
rfgscript $LATTIX_DIR/rfg2ldi2.py $AXIVION_DIR/iceoryx.rfg -i $AXIVION_DIR/iceoryx.ir "Declaration Facts" File out2.ldi
```

From there it is a simple matter to load the files into Lattix and generate the required analysis output

```bash
ldcupdate.sh iceoryx.ldz -module:axivion -deltatags out1.ldi out2.ldi
ldcscript.sh iceoryx.ldz -script:ImportExportRules.importRules -file:lattix/iceoryx_rules.rul -save
ldcreport.sh iceoryx.ldz -violations_with_lines -report:csv -reportfile:lattix-violations.csv
ldcreport.sh iceoryx.ldz -cycles -report:csv -reportfile:cycles.csv
ldcreport.sh iceoryx.ldz -reportfile:dsm.png -reportView:1:none
ldcreport.sh iceoryx.ldz -reportfile:heatmap.png -reportView:1:all
```

## VectorCAST Integration (Unsuccessful)

VectorCAST, in common with Axivion, has to run the build commands using its own compiler to analyse the software. This should be possible with the following commands:

```bash
vcshell cmake -Bbuild -Hiceoryx_meta
vcshell cmake --build build
```

Alternatively, the following should work:

```bash
cd build/
vcshell make
```

Unfortunately, currently there is no solution for integration of VectorCAST analysis into the iceoryx pipeline.
